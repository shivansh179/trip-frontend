'use client';

import { CreditCard, Smartphone, Building2, QrCode, CheckCircle, Calendar, Percent, TrendingUp } from 'lucide-react';
import { useState, useEffect } from 'react';
import { QRCodeSVG } from 'qrcode.react';

interface EmiOption {
    tenure: number;
    interestRate: number;
    monthlyAmount: number;
    totalAmount: number;
    interestAmount: number;
    noCost: boolean;
    label: string;
    description: string;
}

interface PaymentMethodsProps {
    selectedMethod: string;
    onMethodChange: (method: string) => void;
    amount: number;
    bookingReference?: string;
    selectedEmi?: EmiOption | null;
    onEmiChange?: (emi: EmiOption | null) => void;
}

export default function PaymentMethods({ selectedMethod, onMethodChange, amount, bookingReference, selectedEmi, onEmiChange }: PaymentMethodsProps) {
    const [showQRCode, setShowQRCode] = useState(false);
    const [emiOptions, setEmiOptions] = useState<EmiOption[]>([]);
    const [showEmi, setShowEmi] = useState(false);
    const [selectedEmiLocal, setSelectedEmiLocal] = useState<EmiOption | null>(null);
    const [cardData, setCardData] = useState({
        cardNumber: '',
        expiryDate: '',
        cvv: '',
        cardholderName: '',
    });

    // Fetch EMI options when amount changes
    useEffect(() => {
        const fetchEmiOptions = async () => {
            if (amount >= 2500) {
                try {
                    // Use API_BASE_URL which already includes /api
                    const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://trip-backend-65232427280.asia-south1.run.app/api';
                    const response = await fetch(`${API_URL}/emi/options?amount=${amount}`);
                    const data = await response.json();
                    if (data.eligible && data.options) {
                        setEmiOptions(data.options);
                    }
                } catch (error) {
                    console.error('Failed to fetch EMI options:', error);
                    // Use fallback local calculation
                    const fallbackOptions: EmiOption[] = [
                        {
                            tenure: 3,
                            interestRate: 0,
                            monthlyAmount: Math.ceil(amount / 3),
                            totalAmount: amount,
                            interestAmount: 0,
                            noCost: true,
                            label: '3 Months No-Cost EMI',
                            description: `Pay â‚¹${Math.ceil(amount / 3).toLocaleString('en-IN')}/month with 0% interest`
                        },
                        {
                            tenure: 6,
                            interestRate: 16,
                            monthlyAmount: Math.ceil(calculateEmi(amount, 6, 16)),
                            totalAmount: Math.ceil(calculateEmi(amount, 6, 16) * 6),
                            interestAmount: Math.ceil(calculateEmi(amount, 6, 16) * 6 - amount),
                            noCost: false,
                            label: '6 Months EMI @ 16% p.a.',
                            description: `Pay â‚¹${Math.ceil(calculateEmi(amount, 6, 16)).toLocaleString('en-IN')}/month`
                        }
                    ];
                    setEmiOptions(fallbackOptions);
                }
            } else {
                setEmiOptions([]);
            }
        };

        fetchEmiOptions();
    }, [amount]);

    // EMI calculation helper
    const calculateEmi = (principal: number, months: number, annualRate: number) => {
        const r = annualRate / 12 / 100;
        return principal * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1);
    };

    const handleEmiSelect = (emi: EmiOption | null) => {
        setSelectedEmiLocal(emi);
        if (onEmiChange) {
            onEmiChange(emi);
        }
    };

    const paymentMethods = [
        {
            id: 'upi',
            name: 'UPI',
            icon: Smartphone,
            discount: 5,
            description: 'Pay using UPI apps like PhonePe, Google Pay, Paytm',
        },
        {
            id: 'credit_card',
            name: 'Credit Card',
            icon: CreditCard,
            discount: 3,
            description: 'Visa, Mastercard, Amex â€¢ EMI available',
        },
        {
            id: 'debit_card',
            name: 'Debit Card',
            icon: CreditCard,
            discount: 3,
            description: 'Visa, Mastercard, RuPay',
        },
    ];

    const formatCardNumber = (value: string) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        const matches = v.match(/\d{4,16}/g);
        const match = (matches && matches[0]) || '';
        const parts = [];
        for (let i = 0, len = match.length; i < len; i += 4) {
            parts.push(match.substring(i, i + 4));
        }
        if (parts.length) {
            return parts.join(' ');
        }
        return v;
    };

    const formatExpiryDate = (value: string) => {
        const v = value.replace(/\D/g, '');
        if (v.length >= 2) {
            return v.substring(0, 2) + '/' + v.substring(2, 4);
        }
        return v;
    };

    const generateUPIQRCode = () => {
        // Generate UPI payment URL
        const upiId = 'ylootrips@paytm'; // Replace with your actual UPI ID
        const merchantName = 'YlooTrips';
        const transactionNote = bookingReference ? `Booking ${bookingReference}` : 'Trip Booking';
        const amountStr = amount.toFixed(2);

        // UPI Deep Link Format
        const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amountStr}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

        return upiUrl;
    };

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-light mb-6 flex items-center gap-3">
                <CreditCard size={28} className="text-secondary" />
                Payment Method
            </h2>

            {/* Payment Method Selection */}
            <div className="space-y-3">
                {paymentMethods.map((method) => {
                    const Icon = method.icon;
                    const isSelected = selectedMethod === method.id;

                    return (
                        <label
                            key={method.id}
                            className={`flex items-start gap-4 p-5 border-2 rounded-lg cursor-pointer transition-all ${isSelected
                                ? 'border-secondary bg-secondary/5'
                                : 'border-primary/20 bg-white hover:border-primary/40'
                                }`}
                        >
                            <input
                                type="radio"
                                name="paymentMethod"
                                value={method.id}
                                checked={isSelected}
                                onChange={(e) => {
                                    onMethodChange(e.target.value);
                                    setShowQRCode(false);
                                }}
                                className="mt-1 text-secondary"
                            />
                            <div className="flex-1">
                                <div className="flex items-center gap-3 mb-1">
                                    <Icon size={24} className={isSelected ? 'text-secondary' : 'text-primary/60'} />
                                    <span className="text-body-lg font-medium">{method.name}</span>
                                    {method.discount > 0 && (
                                        <span className="text-body-sm text-success font-medium bg-success/10 px-2 py-1 rounded">
                                            {method.discount}% OFF
                                        </span>
                                    )}
                                </div>
                                <p className="text-body-sm text-text-secondary">{method.description}</p>
                            </div>
                            {isSelected && (
                                <CheckCircle size={20} className="text-secondary shrink-0 mt-1" />
                            )}
                        </label>
                    );
                })}
            </div>

            {/* Payment Type Selection - Full Payment vs EMI (Credit Card Only) */}
            {selectedMethod === 'credit_card' && emiOptions.length > 0 && (
                <div className="mt-6 space-y-4">
                    <h3 className="text-lg font-medium text-primary">How would you like to pay?</h3>

                    {/* Two Choice Toggle */}
                    <div className="grid grid-cols-2 gap-4">
                        {/* Full Payment Option */}
                        <label
                            className={`relative p-5 border-2 rounded-lg cursor-pointer transition-all ${!showEmi
                                ? 'border-secondary bg-secondary/5 shadow-md'
                                : 'border-primary/20 bg-white hover:border-primary/40'
                                }`}
                        >
                            <input
                                type="radio"
                                name="paymentType"
                                checked={!showEmi}
                                onChange={() => {
                                    setShowEmi(false);
                                    handleEmiSelect(null);
                                }}
                                className="sr-only"
                            />
                            <div className="text-center">
                                <CreditCard size={32} className={!showEmi ? 'text-secondary mx-auto mb-2' : 'text-primary/40 mx-auto mb-2'} />
                                <p className="font-medium text-body-lg">Pay Full Amount</p>
                                <p className="text-2xl font-bold mt-2">â‚¹{amount.toLocaleString('en-IN')}</p>
                                <p className="text-body-sm text-success mt-1">3% discount applied</p>
                            </div>
                            {!showEmi && (
                                <CheckCircle size={20} className="absolute top-3 right-3 text-secondary" />
                            )}
                        </label>

                        {/* EMI Option */}
                        <label
                            className={`relative p-5 border-2 rounded-lg cursor-pointer transition-all ${showEmi
                                ? 'border-secondary bg-secondary/5 shadow-md'
                                : 'border-primary/20 bg-white hover:border-primary/40'
                                }`}
                        >
                            <input
                                type="radio"
                                name="paymentType"
                                checked={showEmi}
                                onChange={() => setShowEmi(true)}
                                className="sr-only"
                            />
                            <div className="text-center">
                                <Calendar size={32} className={showEmi ? 'text-secondary mx-auto mb-2' : 'text-primary/40 mx-auto mb-2'} />
                                <p className="font-medium text-body-lg">Pay with EMI</p>
                                <p className="text-2xl font-bold mt-2">â‚¹{Math.ceil(amount / 3).toLocaleString('en-IN')}<span className="text-sm font-normal">/mo</span></p>
                                <p className="text-body-sm text-text-secondary mt-1">Credit Cards Only</p>
                            </div>
                            {showEmi && (
                                <CheckCircle size={20} className="absolute top-3 right-3 text-secondary" />
                            )}
                        </label>
                    </div>

                    {/* EMI Plans - Show only when EMI is selected */}
                    {showEmi && (
                        <div className="bg-cream-light border border-primary/10 rounded-lg p-5 mt-4">
                            <h4 className="text-body-lg font-medium mb-4">Select EMI Plan</h4>
                            <div className="space-y-3">
                                {emiOptions.map((emi) => {
                                    const isSelected = selectedEmiLocal?.tenure === emi.tenure;
                                    return (
                                        <div
                                            key={emi.tenure}
                                            onClick={() => handleEmiSelect(emi)}
                                            className={`flex items-center gap-4 p-4 border-2 rounded-lg cursor-pointer transition-all ${isSelected
                                                ? 'border-secondary bg-white shadow-sm'
                                                : 'border-primary/10 bg-white hover:border-primary/30'
                                                }`}
                                        >
                                            {/* Custom Radio Circle */}
                                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-primary' : 'border-gray-400'
                                                }`}>
                                                {isSelected && (
                                                    <div className="w-3 h-3 rounded-full bg-primary"></div>
                                                )}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-medium">{emi.tenure} Months</span>
                                                    {emi.noCost && (
                                                        <span className="text-xs font-bold bg-success text-white px-2 py-0.5 rounded">
                                                            NO COST
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-body-sm text-text-secondary">
                                                    {emi.noCost
                                                        ? `â‚¹${emi.monthlyAmount?.toLocaleString('en-IN')}/month Ã— ${emi.tenure} = â‚¹${emi.totalAmount?.toLocaleString('en-IN')}`
                                                        : `â‚¹${emi.monthlyAmount?.toLocaleString('en-IN')}/month Ã— ${emi.tenure} = â‚¹${emi.totalAmount?.toLocaleString('en-IN')} (incl. â‚¹${emi.interestAmount?.toLocaleString('en-IN')} interest)`
                                                    }
                                                </p>
                                            </div>
                                            <span className="text-xl font-bold text-secondary">
                                                â‚¹{emi.monthlyAmount?.toLocaleString('en-IN')}
                                            </span>
                                        </div>
                                    );
                                })}
                            </div>

                            {!selectedEmiLocal && (
                                <p className="text-body-sm text-amber-600 mt-3 flex items-center gap-2">
                                    <span className="text-lg">ðŸ‘†</span> Please select an EMI plan to continue
                                </p>
                            )}

                            {selectedEmi?.noCost && (
                                <div className="bg-success/10 border border-success/20 p-3 rounded-lg mt-4">
                                    <p className="text-body-sm text-success">
                                        âœ“ No-Cost EMI - You pay exactly â‚¹{selectedEmi.totalAmount?.toLocaleString('en-IN')} with 0% interest
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            )}

            {/* UPI QR Code Section */}
            {selectedMethod === 'upi' && (
                <div className="mt-6 p-6 bg-cream-light border border-primary/10 rounded-lg">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-xl font-light flex items-center gap-2">
                            <QrCode size={24} className="text-secondary" />
                            UPI Payment
                        </h3>
                        <button
                            type="button"
                            onClick={() => setShowQRCode(!showQRCode)}
                            className="text-body-sm text-secondary hover:text-primary transition-colors"
                        >
                            {showQRCode ? 'Hide QR Code' : 'Show QR Code'}
                        </button>
                    </div>

                    {showQRCode ? (
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded-lg border-2 border-dashed border-primary/20 flex flex-col items-center">
                                <div className="w-64 h-64 bg-white border-2 border-primary/10 rounded-lg flex items-center justify-center mb-4 p-4">
                                    <QRCodeSVG
                                        value={generateUPIQRCode()}
                                        size={240}
                                        level="H"
                                        includeMargin={true}
                                        className="w-full h-full"
                                    />
                                </div>
                                <p className="text-body-sm text-text-secondary text-center mb-4">
                                    Scan this QR code with PhonePe, Google Pay, Paytm, or any UPI app
                                </p>
                                <div className="bg-primary/5 p-4 rounded-lg w-full">
                                    <p className="text-caption text-text-secondary mb-1">UPI ID</p>
                                    <p className="text-body-lg font-mono">ylootrips@paytm</p>
                                </div>
                                <div className="bg-primary/5 p-4 rounded-lg w-full mt-2">
                                    <p className="text-caption text-text-secondary mb-1">Amount</p>
                                    <p className="text-body-lg font-semibold">â‚¹{amount.toLocaleString('en-IN')}</p>
                                </div>
                            </div>
                            <div className="bg-accent/10 p-4 rounded-lg">
                                <p className="text-body-sm text-text-secondary">
                                    <strong>Note:</strong> After scanning and completing payment, click "Complete Booking" to proceed.
                                    Your payment will be verified automatically.
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-4 rounded-lg border border-primary/10">
                            <p className="text-body-sm text-text-secondary">
                                Click "Show QR Code" to display the payment QR code, or proceed to pay via UPI gateway.
                            </p>
                        </div>
                    )}
                </div>
            )}

            {/* Card details are collected on Easebuzz payment page - no need to collect here */}

            {/* Net Banking Info */}
            {/* {selectedMethod === 'netbanking' && (
                <div className="mt-6 p-6 bg-cream-light border border-primary/10 rounded-lg">
                    <h3 className="text-xl font-light mb-4 flex items-center gap-2">
                        <Building2 size={24} className="text-secondary" />
                        Net Banking
                    </h3>
                    <div className="bg-white p-4 rounded-lg border border-primary/10">
                        <p className="text-body-sm text-text-secondary mb-4">
                            You will be redirected to your bank's secure payment page to complete the transaction.
                        </p>
                        <div className="grid grid-cols-3 gap-3">
                            {['HDFC', 'ICICI', 'SBI', 'Axis', 'Kotak', 'PNB'].map((bank) => (
                                <div
                                    key={bank}
                                    className="p-3 border border-primary/10 rounded-lg text-center hover:border-secondary transition-colors cursor-pointer"
                                >
                                    <p className="text-body-sm font-medium">{bank}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )} */}

            {/* Security Notice */}
            <div className="bg-accent/10 p-4 rounded-lg border border-accent/20">
                <div className="flex items-start gap-3">
                    <CheckCircle size={20} className="text-success mt-0.5 shrink-0" />
                    <div>
                        <p className="text-body-sm font-medium text-primary mb-1">Secure Payment</p>
                        <p className="text-body-sm text-text-secondary">
                            Your payment information is encrypted and secure. We never store your card details.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
}

